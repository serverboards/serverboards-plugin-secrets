!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t():"function"==typeof define&&define.amd?define(t):t()}(0,function(){"use strict";var e=Serverboards.React,t=Serverboards.Components.HoldButton;var r=e.createClass({displayName:"Header",componentDidMount:function(){$(this.refs.secret_select).dropdown({})},handleSecretSelect:function(e){e.target.value&&this.props.onSecretSelect(e.target.value)},componentWillReceiveProps:function(e){var t=this;e.secret!=this.props.secret&&setTimeout(function(){e.secret?$(t.refs.secret_select).dropdown("set selected",e.secret):$(t.refs.secret_select).dropdown("clear")},20)},render:function(){var r=this.props;return e.createElement("div",{className:"ui top secondary menu"},e.createElement("div",{className:"right menu"},r.onDelete?e.createElement(t,{className:"ui outline button red",onHoldClick:r.onDelete},"Hold to remove"):null,e.createElement("select",{className:"ui dropdown search small",name:"secret",ref:"secret_select",onChange:this.handleSecretSelect,value:r.secret},e.createElement("option",{value:""},"Select a secret"),function(e){return e.sort(),e}(Object.keys(r.secrets)).map(function(t){return e.createElement("option",{key:t,value:t},r.secrets[t])})),e.createElement("a",{className:"item",onClick:r.onSecretAdd},e.createElement("i",{className:"ui icon add"}))))}}),n=Serverboards.React;function a(e){return n.createElement("div",{className:"ui container"},n.createElement("div",{className:"ui form"},n.createElement("div",{className:"field"},n.createElement("label",null,"Password"),n.createElement("input",{type:"password",id:"password",placeholder:"Secret password"})),n.createElement("div",{className:"field"},n.createElement("button",{className:"ui button yellow",onClick:function(){var t=$("#secrets input#password").val();e.onPasswordSet(t)}},"Decrypt ",n.createElement("i",{className:"ui icon right arrow"})))))}var s=Serverboards.React,i={document:"file text",text:"file text","application/vnd.oasis.opendocument.spreadsheet":"file excel outline",image:"file image"},l={verticalAlign:"top"};function c(e){var t=e.data.slice(5,e.data.indexOf(";"));switch(console.log(e.data.slice(0,20),t),t){case"image/gif":case"image/svg":case"image/png":case"image/jpg":case"image/jpeg":return s.createElement("img",{src:e.data,className:"ui top aligned avatar image"})}return i[t]?s.createElement("i",{style:l,className:"icon big black "+i[t]}):(t=t.slice(t.indexOf("/")),i[t]?s.createElement("i",{style:l,className:"icon big black "+i[t]}):s.createElement("i",{style:l,className:"icon big black file"}))}var o=Serverboards.React;function d(e){return 1024>e?e+" Bytes":1048576>e?(e/1024).toFixed(2)+" KB":1073741824>e?(e/1048576).toFixed(2)+" MB":void 0}function u(e){return o.createElement("div",null,o.createElement(c,e),o.createElement("div",{style:{display:"inline-block"}},o.createElement("div",null,e.name),o.createElement("div",{className:"ui meta"},d(e.size)||"~ "+d(3*e.data.length/4))))}var m=Serverboards.plugin,p={uuid4:function(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(e){var t=0|16*Math.random();return("x"==e?t:8|3&t).toString(16)})}};m.load("serverboards.secrets/sjcl.js").then(function(){console.log(sjcl),p.encrypt=sjcl.encrypt,p.decrypt=sjcl.decrypt});!function(){function e(e){this.value=e}function t(t){var r,n;function a(r,n){try{var i=t[r](n),l=i.value;l instanceof e?Promise.resolve(l.value).then(function(e){a("next",e)},function(e){a("throw",e)}):s(i.done?"return":"normal",i.value)}catch(e){s("throw",e)}}function s(e,t){switch(e){case"return":r.resolve({value:t,done:!0});break;case"throw":r.reject(t);break;default:r.resolve({value:t,done:!1})}(r=r.next)?a(r.key,r.arg):n=null}this._invoke=function(e,t){return new Promise(function(s,i){var l={key:e,arg:t,resolve:s,reject:i,next:null};n?n=n.next=l:(r=n=l,a(e,t))})},"function"!=typeof t.return&&(this.return=void 0)}"function"==typeof Symbol&&Symbol.asyncIterator&&(t.prototype[Symbol.asyncIterator]=function(){return this}),t.prototype.next=function(e){return this._invoke("next",e)},t.prototype.throw=function(e){return this._invoke("throw",e)},t.prototype.return=function(e){return this._invoke("return",e)}}();var h=function(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e},f=Serverboards,v=f.React,S=f.Flash,E=v.createClass({displayName:"EditSecret",componentDidMount:function(){$(this.refs.el).find(".ui.checkbox").checkbox()},handleEncrypt:function(){var e=this,t=$(this.refs.content).val(),r=$(this.refs.password).val(),n=$(this.refs.title).val();if(r)if(6>r.length)S.error("Password too short! At least 6 characters.");else if(r==$(this.refs.password_repeat).val()){var a={text:t,files:(this.props.files||[]).filter(function(t){return $(e.refs.el).find('input[type=checkbox][name="'+t.name+'"]').is(":checked")})||[]},s=[];if(0<this.refs.upload.files.length){var i=!0,l=!1,c=void 0;try{for(var o,d=function(){var e=o.value,t=new Promise(function(t){var r=new FileReader;r.onload=function(r){a.files.push({name:e.name,data:r.target.result,size:e.size}),t()},r.readAsDataURL(e)});console.log(s),s.push(t)},u=this.refs.upload.files[Symbol.iterator]();!(i=(o=u.next()).done);i=!0)d()}catch(e){l=!0,c=e}finally{try{!i&&u.return&&u.return()}finally{if(l)throw c}}}Promise.all(s).then(function(){var t=JSON.stringify(a),s=p.encrypt(r,t);e.props.onSave(n,s)})}else S.error("Passwords do not match!");else S.error("Cant use empty password.")},render:function(){var e=this.props;return v.createElement("div",{className:"ui text container"},v.createElement("div",{ref:"el",className:"ui form"},v.createElement("div",{className:"field"},v.createElement("label",null,"Secret Name"),v.createElement("input",{type:"text",ref:"title",defaultValue:e.title})),v.createElement("div",{className:"field"},v.createElement("label",null,"Text"),v.createElement("textarea",{id:"plain",ref:"content",style:{minHeight:"calc( 100vh - 33em )"},defaultValue:e.content})),v.createElement("div",{className:"field"},v.createElement("label",null,"Upload new file"),v.createElement("input",{type:"file",ref:"upload",multiple:!0}),0<(e.files||[]).length?v.createElement("div",null,v.createElement("label",null,"Files to keep"),v.createElement("div",{className:"ui meta"},"Unmark files to remove them from the secret"),v.createElement("div",{className:"ui three column grid"},(e.files||[]).map(function(e){return v.createElement("div",{className:"field column"},v.createElement("div",{className:"ui checkbox"},v.createElement("input",h({type:"checkbox",className:"ui checkbox",name:e.name,checked:!0},"className","hidden")),v.createElement("label",null,v.createElement(u,e))))}))):null),v.createElement("div",{className:"inline field"},v.createElement("label",null,"Password: "),v.createElement("input",{type:"password",defaultValue:e.password,ref:"password"}),v.createElement("label",null," Repeat Password: "),v.createElement("input",{type:"password",defaultValue:e.password,ref:"password_repeat"})," ",v.createElement("button",{className:"ui button yellow",onClick:this.handleEncrypt},"Encrypt"))))}}),g=Serverboards,y=g.React,b=g.Flash,x=Serverboards.Components.MarkdownPreview,w=y.createClass({displayName:"ViewSecret",getInitialState:function(){return{text:void 0,password:void 0,files:[],edit:!1}},handleOpenEdit:function(){this.setState({edit:!0})},handlePasswordSet:function(e){try{var t=JSON.parse(p.decrypt(e,this.props.secret));this.setState({text:t.text,password:e,files:t.files||[]}),this.props.onSecretVisible(!0)}catch(e){console.error(e),b.error("Invalid password. Try again.")}},componentWillReceiveProps:function(e){e.secret!=this.props.secret&&this.setState(this.getInitialState())},render:function(){var e=this.state;return e.edit?y.createElement(E,{password:e.password,content:e.text,title:this.props.title,onSave:this.props.onSave,files:this.state.files}):e.password?y.createElement("div",{className:"ui text container"},y.createElement(x,{value:e.text}),y.createElement("div",{className:"ui divider"}),0<e.files.length?y.createElement("div",null,"Attachments:",y.createElement("div",{className:"ui three column grid"},e.files.map(function(e){return y.createElement("a",{href:e.data,target:"_blank",download:e.name,key:e.name,className:"column"},y.createElement(u,e))})),y.createElement("div",{className:"ui divider"})):null,y.createElement("button",{style:{float:"right"},className:"ui button yellow",onClick:this.handleOpenEdit},"Edit")):y.createElement(a,{onPasswordSet:this.handlePasswordSet})}}),N=Serverboards,k=N.rpc,_=N.React,j=N.Flash,C=N.utils,P="serverboards.secrets",D=_.createClass({displayName:"View",getInitialState:function(){return{secrets:{},title:void 0,secret:void 0,secret_id:void 0,add:!1,visible:!1}},componentDidMount:function(){var e=this;k.call("plugin.data.list",[P,this.props.project+"."]).then(function(t){var r={},n=e.props.project.length+1;t.map(function(e){r[e]=e.slice(n)}),e.setState({secrets:r}),e.state.secret_id&&e.handleSecretSelect(e.state.secret_id)}),this.props.setSectionMenu&&this.props.setSectionMenu(this.render_header)},handleSecretSelect:function(e){var t=this;console.log("secret %o",e),k.call("plugin.data.get",[P,e]).then(function(r){t.setState({secret:r,title:t.state.secrets[e],secret_id:e,add:!1,visible:!1})})},handleAddSecretDialog:function(){this.setState({add:!0,title:"Add a new secret",secret_id:void 0})},handleAddSecret:function(e,t){var r=this,n=this,a=this.props.project+"."+e;k.call("plugin.data.update",[P,a,t]).then(function(s){console.log("Saved encrypted data: %o: %o",e,s);var i=C.merge(r.state.secrets,h({},a,e));n.setState({add:!1,secret:t,title:e,secrets:i,secret_id:a})}).catch(function(e){console.error(e),j.error("Could not save encrypted secret")})},handleDeleteSecret:function(){var e=this,t=this.state.secret_id;k.call("plugin.data.delete",[P,t]).then(function(){console.log("Deleted secret %o",t);var r={};Object.keys(e.state.secrets).map(function(n){n!=t&&(r[n]=e.state.secrets[n])}),e.setState({secret_id:void 0,secrets:r,secret:void 0,title:void 0,visible:!1})})},handleTitleChange:function(e,t,r){var n=this,a={};Object.keys(this.state.secrets).map(function(s){s==e?a[t]=r:a[s]=n.state.secrets[s]}),this.setState({secret_id:t,secrets:a,title:r})},handleSecretVisible:function(){var e=!(0<arguments.length&&void 0!==arguments[0])||arguments[0];this.setState({visible:e})},handleSave:function(e,t){var r=this;k.call("plugin.data.update",[P,this.props.project+"."+e,t]).then(function(){if(e!=r.state.title)return k.call("plugin.data.delete",[P,r.props.project+"."+r.state.title])}).then(function(){return r.reload(r.props.project+"."+e)}).catch(function(e){console.error(e),j.error("Error saving secret")})},reload:function(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:void 0;this.setState(this.getInitialState()),this.setState({secret_id:e}),this.componentDidMount()},render_header:function(e){var t=this.state;return _.createElement(r,{secrets:t.secrets,title:t.title,secret:t.secret_id,onSecretSelect:this.handleSecretSelect,onSecretAdd:this.handleAddSecretDialog,onDelete:t.visible&&this.handleDeleteSecret,show_title:e})},render:function(){var e=this.props,t=this.state;return _.createElement("div",{id:"secrets"},e.setSectionMenu?null:this.render_header(!0),t.add?_.createElement(E,{onSave:this.handleAddSecret}):t.secret?_.createElement(w,{secret:t.secret,title:t.title,onSave:this.handleSave,onSecretChange:t.handleSecretSelect,onSecretVisible:this.handleSecretVisible,reload:this.reload}):_.createElement("div",{className:"ui text container"},"No secret selected. Select a secret from the top menu or add one."))}});Serverboards.add_screen(P+"/screen",function(e,t,r){return console.log("secrets config:",t,r),Serverboards.ReactDOM.render(_.createElement(D,{project:t.project.shortname,setSectionMenu:r.setSectionMenu}),e),function(){Serverboards.ReactDOM.unmountComponentAtNode(e)}})});
